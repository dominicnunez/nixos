# Claude in Chrome Integration Fix for NixOS

## Problem

Claude Code's "Claude in Chrome" browser automation feature doesn't show as "Enabled" when running `/chrome` command on NixOS.

## Root Cause

Claude Code generates a native messaging host script at `~/.claude/chrome/chrome-native-host` with a shebang of `#!/bin/bash`. On NixOS, `/bin/bash` doesn't exist by default - bash is in the Nix store at a path like `/nix/store/.../bin/bash`.

When Chrome tries to launch the native host, it fails with:
```
/bin/bash: bad interpreter: No such file or directory
```

## Components Involved

1. **Chrome Extension**: "Claude in Chrome" extension (ID: `fcoeoabgfenejglbffodgkkbkcdhcgfn`)
2. **Native Messaging Manifest**: `~/.config/google-chrome/NativeMessagingHosts/com.anthropic.claude_code_browser_extension.json`
3. **Native Host Script**: `~/.claude/chrome/chrome-native-host`
4. **Unix Socket**: `/tmp/claude-mcp-browser-bridge-$USER`

## Fix Applied

Added `/bin/bash` symlink to NixOS configuration in `configuration.nix`:

```nix
# Create /bin/bash symlink for compatibility (needed by Claude Code's Chrome integration)
system.activationScripts.binBash = ''
  mkdir -p /bin
  ln -sf ${pkgs.bash}/bin/bash /bin/bash
'';
```

After adding this, run:
```bash
sudo nixos-rebuild switch --flake /home/dom/Code/nixos#nixos
```

## Verification Steps

1. Check `/bin/bash` exists:
   ```bash
   ls -la /bin/bash
   ```

2. Test native host runs:
   ```bash
   ~/.claude/chrome/chrome-native-host --version
   ```
   Should output initialization messages, not "bad interpreter" error.

3. Restart Chrome completely:
   ```bash
   pkill -f google-chrome && google-chrome-stable &
   ```

4. Check native host process is running:
   ```bash
   ps aux | grep chrome-native-host
   ```

5. Check socket exists:
   ```bash
   ls -la /tmp/claude-mcp-browser-bridge-$USER
   ```

6. Check journal logs for successful communication:
   ```bash
   journalctl --user -n 50 | grep -i claude
   ```
   Should show messages like:
   - `[Claude Chrome Native Host] Initializing...`
   - `[Claude Chrome Native Host] Socket server listening for connections`
   - `[Claude Chrome Native Host] Handling Chrome message type: ping`

## Current Status

**IN PROGRESS** - As of 2024-12-22:
- Native host script runs correctly (shebang fix works)
- Chrome successfully communicates with native host (ping/get_status)
- Socket is created and listening

## Second Issue Found: MCP Server Fails

The `/mcp` command showed "Claude-in-chrome MCP Server" with **Status: failed**.

### Root Cause
Claude Code spawns the MCP server with `node` as the command. On this system, fnm (Fast Node Manager) puts a dynamically-linked node in PATH before nix's node. NixOS cannot run dynamically-linked executables, causing the MCP server to fail.

### Solution
Created a user wrapper at `~/.local/bin/claude` that prepends nix's node directory to PATH before calling the real claude. Also modified `terminal.nix` to ensure `~/.local/bin` is first in PATH.

**User wrapper (`~/.local/bin/claude`):**
```bash
#!/usr/bin/env bash
# User wrapper for Claude Code that ensures nix's node is found before fnm's node
# This fixes the Claude in Chrome MCP server which spawns "node" directly

# Get the nix nodejs bin directory and prepend it to PATH
NIX_NODE_DIR="$(dirname "$(readlink -f /etc/profiles/per-user/dom/bin/node)")"
export PATH="$NIX_NODE_DIR:$PATH"

# Call the real claude from nix profile
exec /etc/profiles/per-user/dom/bin/claude "$@"
```

**PATH fix in `terminal.nix`:**
```nix
initExtra = ''
  # Ensure ~/.local/bin is first in PATH (for user wrappers like claude)
  export PATH="$HOME/.local/bin:$PATH"
  # ... rest of config
'';
```

After applying these changes:
1. Run `sudo nixos-rebuild switch --flake /home/dom/Code/nixos#nixos`
2. Start a **new terminal** to pick up PATH changes
3. Run `claude --chrome` and check `/mcp` status

## Files Modified

- `/home/dom/Code/nixos/configuration.nix` - Added `system.activationScripts.binCompatibility` for `/bin/bash` symlink
- `/home/dom/Code/nixos/modules/home-manager/terminal.nix` - Added `~/.local/bin` to beginning of PATH
- `/home/dom/.local/bin/claude` - User wrapper that ensures nix's node is found first

## Related Files

- `~/.claude/chrome/chrome-native-host` - Auto-generated by Claude Code, don't manually edit (will be overwritten)
- `~/.config/google-chrome/NativeMessagingHosts/com.anthropic.claude_code_browser_extension.json` - Created by extension
- `~/.claude/settings.json` - Claude Code settings (no chrome-specific settings found)
